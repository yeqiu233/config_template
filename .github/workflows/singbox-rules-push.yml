name: ğŸ› ï¸ è‡ªåŠ¨ç¼–è¯‘Singboxçš„ç§äººè§„åˆ™é›†

on:
  push:
    paths:
      - 'rules/singbox/**/*.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. å®‰è£… sing-box CLI
      - name: Install sing-box
        run: |
          curl -fsSL https://sing-box.app/install.sh | sh

      # 3. æŸ¥æ‰¾æ‰€æœ‰ .json æ–‡ä»¶å¹¶ç¼–è¯‘
      - name: Compile rule-sets
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰ .json æ–‡ä»¶å¹¶ç¼–è¯‘å¯¹åº”çš„è§„åˆ™é›†
          find rules/singbox/ -type f -name "*.json" | while read json_file; do
            # è·å–æ–‡ä»¶çš„ç›®å½•å’Œæ–‡ä»¶åï¼ˆä¸å¸¦æ‰©å±•åï¼‰
            base_name=$(basename "$json_file" .json)
            output_file="${json_file%.json}.srs"
            # ç¼–è¯‘è§„åˆ™é›†
            echo "ç¼–è¯‘è§„åˆ™é›†: $json_file"
            sing-box rule-set compile --output "$output_file" "$json_file"
          done

      # 4. æäº¤å¹¶æ¨é€ç¼–è¯‘ç»“æœ
      - name: Commit and push compiled rules
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # ç¡®ä¿ä»“åº“æ˜¯æœ€æ–°çš„
          git pull origin main

          # æ·»åŠ æ‰€æœ‰ .srs æ–‡ä»¶
          git add 'rules/singbox/**/*.srs'

          # æäº¤æ›´æ”¹
          git commit -m "æ›´æ–°æœ€æ–°ç§äººsingboxè§„åˆ™é›†" || echo "No changes to commit"

          # æ¨é€åˆ°è¿œç¨‹ä»“åº“
          git push origin main
